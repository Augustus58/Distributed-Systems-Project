<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Calculator</title>
    </head>

    <body>
        <h1>Calculator</h1>
        <form>
            <input type="text" name="input" id="tb-input"/>
            <input type="button" value="Calculate" id="btn-submit"/>
            <input type="button" value="Reset" id="btn-reset"/>
        </form>
        <ul style="list-style-type:none" id="li-results"></ul>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script type="text/javascript">
            /* <![CDATA[ */
            $(document).ready(function () {
                var model = new calculator.domain.Operations();
                var view = new calculator.view.Calculator();
                var controller = new calculator.controller.CalculatorController();
                var parsingService = new calculator.service.ParsingService();
                view.setController(controller);
                model.setView(view);
                controller.setModel(model);
                controller.setParsingService(parsingService);                
                view.setSubmitListener();
                view.setResetListener();
                parsingService.setController(controller);
            });
            var calculator = {};
            calculator.domain = {};
            calculator.domain.Operations = (function () {
                function Operations() {
                    var view = {};
                    this.getOperation = function (arg1, arg2, op, caller) {
                        var arg1NoParentheses = arg1.replace('(', '').replace(')', '');
                        var arg2NoParentheses = arg2.replace('(', '').replace(')', '');
                        $.ajax({
                            url: "http://localhost:8080/calculate",
                            data: {"arg1": arg1NoParentheses, "arg2": arg2NoParentheses, "op": op},
                            dataType: 'json',
                            success: function (data, textStatus, jqXHR) {
                                caller.substitute(data.res);
                                view.update(data);
                            }
                        });
                    };
                    this.setView = function (v) {
                        view = v;
                    };
                    this.reset = function () {
                        view.reset();
                    };
                }
                return Operations;
            })();
            calculator.view = {};
            calculator.view.Calculator = (function () {
                function Calculator() {
                    var controller = {};
                    this.update = function (operation) {
                        var textNode = document.createTextNode(operation.arg1 + " " + operation.op + " " + operation.arg2 + " = " + operation.res);
                        var liElement = document.createElement("li");
                        liElement.appendChild(textNode);
                        $(liElement).appendTo($("#li-results"));
                    };
                    this.setSubmitListener = function () {
                        $("#btn-submit").click(function () {
                            controller.updateModel($("#tb-input").val());
                        });
                    };
                    this.setResetListener = function () {
                        $("#btn-reset").click(function () {
                            controller.reset();
                        });
                    };
                    this.reset = function () {
                        $("#li-results").empty();
                    };
                    this.setController = function (c) {
                        controller = c;
                    };
                }
                return Calculator;
            })();
            calculator.controller = {};
            calculator.controller.CalculatorController = (function () {
                function CalculatorController() {
                    var model = {};
                    var parsingService = {};

                    this.setModel = function (m) {
                        model = m;
                    };
                    this.getModel = function () {
                        return model;
                    };
                    this.setParsingService = function (s) {
                        parsingService = s;
                    };
                    this.reset = function () {
                        model.reset();
                        parsingService.reset();
                    };
                    this.updateModel = function (input) {
                        parsingService.setInput(input);
                        parsingService.parseInput();
                    };
                }
                return CalculatorController;
            })();
            calculator.service = {};
            calculator.service.ParsingService = (function () {
                function ParsingService() {
                    var input = {};
                    var indexBefore1 = {};
                    var indexBefore2 = {};
                    var indexAfter1 = {};
                    var indexAfter2 = {};
                    var controller = {};

                    this.setInput = function (input) {
                        this.input = input;
                    };
                    this.setController = function (c) {
                        controller = c;
                    };

                    this.reset = function () {
                        this.input = {};
                        this.indexBefore1 = {};
                        this.indexAfter1 = {};
                        this.indexBefore2 = {};
                        this.indexAfter2 = {};
                    };
                    this.parseInput = function () {
                        if (this.input.includes('+')) {
                            this.parseOperator(this.input.indexOf('+'));
                            return;
                        }
                        if (this.indexOfFirstMinusOperator(this.input) !== -1) {
                            this.parseOperator(this.indexOfFirstMinusOperator(this.input));
                            return;
                        }
                        if (this.input.includes('*')) {
                            this.parseOperator(this.input.indexOf('*'));
                            return;
                        }
                        if (this.input.includes('/')) {
                            this.parseOperator(this.input.indexOf('/'));
                            return;
                        }
                    };
                    this.indexOfFirstMinusOperator = function (input) {
                        if (!input.includes('-'))
                            return -1;
                        if (!input.includes('('))
                            return input.indexOf('-');
                        while (input.includes('(-')) {
                            input = input.replace('(-', '  ');
                        }
                        if (input.includes('-')) {
                            return input.indexOf('-');
                        }
                        return -1;
                    }
                    this.parseOperator = function (firstIndexOfOperator) {
                        if ($.isNumeric(this.input))
                            return;
                        this.indexBefore1 = this.indexOfNumber(this.input, firstIndexOfOperator, true, true);
                        this.indexBefore2 = this.indexOfNumber(this.input, firstIndexOfOperator, true, false);
                        this.indexAfter1 = this.indexOfNumber(this.input, firstIndexOfOperator, false, true);
                        this.indexAfter2 = this.indexOfNumber(this.input, firstIndexOfOperator, false, false);
                        controller.getModel().getOperation(this.input.substring(this.indexBefore1, this.indexBefore2), this.input.substring(this.indexAfter1, this.indexAfter2), this.input[firstIndexOfOperator], this);
                    };
                    this.substitute = function (result) {
                        if (result < 0)
                            result = '(' + result + ')';
                        this.input = this.input.substring(0, this.indexBefore1) + result + this.input.substring(this.indexAfter2, this.input.length);
                        this.parseInput();
                    };
                    this.indexOfNumber = function (input, index, before, beginning) {
                        var retValue = index;
                        while (!$.isNumeric(input[retValue])) {
                            if (before) {
                                retValue--;
                                if (input[retValue] === ')' && !beginning)
                                    return retValue + 1;
                            }
                            else {
                                retValue++;
                                if (input[retValue] === '(' && beginning)
                                    return retValue;
                            }
                        }
                        if (!before && beginning)
                            return retValue;
                        if (before && !beginning)
                            return retValue + 1;
                        while ($.isNumeric(input[retValue]) || input[retValue] === '.') {
                            if (beginning) {
                                retValue--;
                                if (input[retValue] === '-' && input[retValue - 1] === '(') {
                                    return retValue - 1;
                                }
                            }
                            else {
                                retValue++;
                                if (input[retValue] === ')') {
                                    return retValue + 1;
                                }
                            }
                        }
                        if (beginning)
                            return retValue + 1;
                        return retValue;
                    };
                }
                return ParsingService;
            })();
            /* ]]> */
        </script>
    </body>
</html>